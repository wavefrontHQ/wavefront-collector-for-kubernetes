apiVersion: v1
kind: ConfigMap
metadata:
  name: collector-config
  namespace: wavefront-collector
data:
  collector.yaml: |
    clusterName: k8s-cluster
    enableEvents: false
    enableDiscovery: true
    flushInterval: 30s

    # sample configuration to filter events
    # events:
    #   filters:
    #     tagAllowListSets:
    #     - kind:
    #       - "Pod"
    #       reason:
    #       - "Scheduled"
    #     - kind:
    #       - "DaemonSet"
    #       reason:
    #       - "SuccessfulCreate"

    sinks:
    - proxyAddress: wavefront-proxy.wavefront-collector.svc.cluster.local:2878
      filters:
        # Optimized metrics collection to omit peripheral metrics.
        metricDenyList:
        - 'kubernetes.sys_container.*'
        - 'kubernetes.collector.runtime.*'
        - 'kubernetes.*.network.rx_rate'
        - 'kubernetes.*.network.rx_errors_rate'
        - 'kubernetes.*.network.tx_rate'
        - 'kubernetes.*.network.tx_errors_rate'
        - 'kubernetes.*.memory.page_faults'
        - 'kubernetes.*.memory.page_faults_rate'
        - 'kubernetes.*.memory.major_page_faults'
        - 'kubernetes.*.memory.major_page_faults_rate'
        - 'kubernetes.*.filesystem.inodes'
        - 'kubernetes.*.filesystem.inodes_free'
        - 'kubernetes.*.ephemeral_storage.request'
        - 'kubernetes.*.ephemeral_storage.limit'

        # Filter out generated labels
        tagExclude:
        - 'label?controller?revision*'
        - 'label?pod?template*'
        - 'annotation_kubectl_kubernetes_io_last_applied_configuration'

    sources:
      # The Wavefront Kubernetes dashboards rely on the "kubernetes." prefix by default. See https://docs.wavefront.com/wf_kubernetes_troubleshooting.html for more details.
      kubernetes_source:
        url: 'https://kubernetes.default.svc'
        kubeletPort: 10250
        kubeletHttps: true
        useServiceAccount: true
        insecure: true
        prefix: 'kubernetes.' # Default prefix

        filters:
          metricDenyList:
          - 'kubernetes.sys_container.*'

      internal_stats_source:
        prefix: 'kubernetes.' # Default prefix

      kubernetes_state_source:
        prefix: 'kubernetes.' # Default prefix

      # kubernetes_cadvisor_source:
      #  prefix: 'kubernetes.cadvisor.'
      #  filters:
      #    metricAllowList:
      #    - "kubernetes.cadvisor.container.cpu.cfs.throttled.seconds.total.counter"
      #    - "kubernetes.cadvisor.container.cpu.cfs.throttled.periods.total.counter"


      prometheus_sources:

      ##########################################################################
      # Static source to collect control plane metrics from the API Server
      ##########################################################################
       - url: 'https://kubernetes.default.svc.cluster.local:443/metrics'
         httpConfig:
           bearer_token_file: '/var/run/secrets/kubernetes.io/serviceaccount/token'
           tls_config:
             ca_file: '/var/run/secrets/kubernetes.io/serviceaccount/ca.crt'
             insecure_skip_verify: true
         prefix: 'kube.apiserver.'

         filters:
           metricAllowList:
           - 'kube.apiserver.etcd.request.duration.seconds.bucket'
           - 'kube.apiserver.etcd.object.counts.gauge'
           - 'kube.apiserver.etcd.db.total.size.in.bytes.gauge'
           - 'kube.apiserver.apiserver.request.duration.seconds.bucket'
           - 'kube.apiserver.apiserver.request.total.counter'
           - 'kube.apiserver.workqueue.adds.total.counter'
           - 'kube.apiserver.workqueue.queue.duration.seconds.bucket'

    # discovery rules for auto-discovery of pods and services
    discovery:
      enable_runtime_plugins: true
      # annotation_excludes:
      # - labels:
      #     please-exclude-from-discovery: ['true']

      plugins:
      # auto-discover coredns
      - name: coredns-discovery
        type: prometheus
        selectors:
          images:
            - '*coredns:*'
          labels:
            k8s-app:
              - kube-dns
        port: 9153
        path: /metrics
        scheme: http
        filters:
          metricAllowList:
            - 'coredns.dns.request.duration.seconds.bucket'
            - 'coredns.dns.responses.total.counter'